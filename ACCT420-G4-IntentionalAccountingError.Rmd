---
title: "<center> ACCT420-G4-IntentionalAccountingError </center>"
author: <center> Adrian Kevin Wijono - G1029244T </center>  <center> Jordan Steve - </center>  <center> Lam - </center>  <center> Ong Wei Bin - </center>  <center> Tung -  </center>  <center> <h4> Prepared for Prof. Wang Jiwei </h4> </center>  <center> <h4> Submitted on 8 April 2019 </h4> </center>   
output:
  html_document:
    theme: paper
    df_print: paged
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: true
    self_contained: no
---

<center> ![](http://diysolarpanelsv.com/images/smu-logo-clipart-33.png){width=1000px} </center>

# Introduction

In the accounting field, an error in a submitted firm's annual report can be classified under accounting error (wrong figure stated due to miscalculation on the firm's part). Unfortunately, this error can be both intentional or not. This project covers our chosen machine learning model to better predict intentional accounting errors, also known as Accounting Fraud. 

The outcome variable is a binary classification, with existing labels on the training data provided in the project brief. This classifies this project under a supervised learning project. 

Train and test data are provided, split by timestamp (train 2005-2009, test 2010) with the binary outcome variable omitted from the test data. As the data does not have any financial information, we extracted data from the CRSP/COMPUSTAT MERGED database from WRDS to build our model. These variables are either used as they are, or further processed into more useful measures such as %growth or ratios as inputs to the model.

Exploratory Data Analysis was also done to see the distribution of the output/outcome variable ("Restate_Int") by company, year, month and quarter to try and identify patterns to the occurence. It is apparent that the frequency of such accounting frauds are extremely rare and there isn't any noticeable pattern/trend. 

For the modelling, we utilized <**INSERT METHODS @TUNG**>

# Variable Selection

In this section, we queried data from the WRDS database (CRSP-COMPUSTAT MERGED) to extract relevant financial as well as non-financial variables as X-variables. The next section wil outline the selected variables in detail and the reason for selecting these variables. 

## Single Variable

This contains variables that are directly obtainable from WRDS database. It will be organized based on the general account type it falls under, with reasons why it was selected.

### Assets 

+---------------+--------------------------+
| Variable Name | Accounting Name          |
+:=============:+:========================:+
| act           | Current Assets - Total   |
+---------------+--------------------------+

These variables provide an overall idea of the scale of the company. Because companies may engage in fraud that will result in their assets being overstated, assets are necessary to be included in the analysis. While the balances of more specific sub-classifications of assets may be more informative and indicative of any specific fraud risk, these variables are still chosen as a machine learning algorithm may have difficulties developing a consistent rule or generalisation based on more specific sub-classifications of assets. One such example is that a company may choose to manipulate Property, Plant and Equipment - Total (Net) account while another may choose to manipulate Receivables Total account.

Companies may generally be more incentivised to manipulate assets by recording assets they neither control nor own, or by inflating the fair value of their assets. Fair value inflation may be done by: improper estimation of the amounts of future cash flows, improper estimation of the timing of future cash flows, utilising an improper discount rate, and so on. Companies may also treat reductions in fair value as temporary impairments, when this is not appropriate. Alternatively, assets may be written down and when subsequently sold, greater profits/gains may be recorded.

#### Fixed Assets

+---------------+---------------------------------------------+
| Variable Name | Accounting Name                             |
+:=============:+:===========================================:+
| ppent         | Property, Plant and Equipment - Total (Net) |
+---------------+---------------------------------------------+

Fixed assets, such as property, plant and equipment, are long-term assets. If the revaluation model is used for these assets, fraud can be perpetuated by overstating the respective fair values. Companies may also retain obsolete and unused assets on their statement of financial position, which not only overstates assets but also overstates net income since losses incurred when disposing these assets are not accounted for.

#### Goodwill

+---------------+-----------------------+
| Variable Name | Accounting Name       |
+:=============:+:=====================:+
| gdwl          | Goodwill              |
+---------------+-----------------------+

As an intangible asset, goodwill may be inflated without any consequences because physically they may not have value. As such, there is a high possibiltiy to goodwill being overstated, or its amortization being understated without any valid reason.

### Liabilities

+---------------+--------------------------------+
| Variable Name | Accounting Name                |
+:=============:+:==============================:+
| dltt          | Long-term Debt                 |
+---------------+--------------------------------+

Liabilities represent a company’s financial obligations to third parties. Companies have an incentive to understate their liabilities to make their statements of financial position appear healthier, as well as to avoid breaching debt covenants. Other ways of concealing liabilities include taking loans from related entities and writing off debts as forgiven bad debts. Companies may also overstate liabilities if they are practising “cookie jar” accounting, which involves creating reserves during years of good performance; the reserves are subsequently tapped into to inflate performance in bad years. Such liabilities may include things like provisions for restructuring or unearned income. Through this, companies can smooth out volatility in their financial performance, misleading investors into believing that they are consistently meeting earnings targets.

### Income

#### Revenue

+---------------+-------------------------------+
| Variable Name | Accounting Name               |
+:=============:+:=============================:+
| revt          | Revenue - Total               |
+---------------+-------------------------------+

Companies have a strong incentive to overstate revenue to improve their apparent financial performance. Revenue can be overstated via several methods: fictitious sales from fictitious customers, fictitious sales from real customers, modification of invoices for actual sales, recording revenue in the wrong period, recording revenue as earned instead of unearned, variable selling prices, channel stuffing (sell retailers more products than they are expected to sell and round-tripping, which involves making a “sale” to another party, often a related entity, then buying back the item “sold”. 

### Expenses

+---------------+----------------------+
| Variable Name | Accounting Name      |
+:=============:+:====================:+
| xlr           | Staff Expense - Total|
+---------------+----------------------+

Expenses may be understated in order to fraudulently inflate profit levels. One method would be capitalising expenses improperly. The following categories of expenses are more likely to be improperly capitalised: start-up costs, research and development costs, repairs and maintenance recorded under property, plant and equipment, software development and acquisition, websites, development of intangible assets, advertising, and other deferrals and prepaid expenses. Alternatively, expenses may be deferred to later periods. Another measure, which may be used in poorly performing years, is known as a “big bath” strategy and may involve, among other methods, recording write-offs, which are subsequently reversed to inflate profits.

#### Cost of Goods Sold

+---------------+--------------------+
| Variable Name | Accounting Name    |
+:=============:+:==================:+
| cogs          | Cost of Goods Sold |
+---------------+--------------------+

The cost of goods sold may be understated if methods like inventory overstatement are employed. 

#### Amortization and Depreciation

+---------------+-------------------------------------------------------------+
| Variable Name | Accounting Name                                             |
+:=============:+:===========================================================:+
| dp            | Comprehensive Income - Total                                |
+---------------+-------------------------------------------------------------+

Amortization and depreciation may be manipulated by adjusting the useful lives of assets, resulting in a reduction in expense. 

### Profit

+---------------+-------------------------------------+
| Variable Name | Accounting Name                     |
+:=============:+:===================================:+
| ebit          | Earnings Before Interest and Taxes  |
+---------------+-------------------------------------+

Companies have an incentive to overstate profit, and this can be done by overstating revenue and/or understating expenses. An important implication of earning manipulation is that it is a combination of aggressive interpretation and application of accounting rules. This signals that if profit manipulation is present, other variables may be manipulated to the benefit of the firm as well.
 
### Cash Flow

+---------------+-----------------------------------------+
| Variable Name | Accounting Name                         |
+:=============:+:=======================================:+
| dv            | Cash Dividends (Cash Flow)              |
+---------------+-----------------------------------------+

Cash flows may be inflated to improve a company’s reported performance. Companies may manipulate cash flow via several methods. One is manipulating accounts payable, possibly by writing cheques and not deducting the amount on the cheques. Another would be to speed up the recognition of receivables, though this leads to poorer cash flows in the subsequent period. Companies may also classify non-operating cash flows as operating cash flows.  

### Shares

+---------------+--------------------------------------------------------------------+
| Variable Name | Accounting Name                                                    |
+:=============:+:==================================================================:+
| bkvlps        | Book Value Per Share                                               |
+---------------+--------------------------------------------------------------------+

Shares represent how profitable a company is. As a company becomes more profitable, then shares price as well as the payout will usually be high as well. Of course, companies will try to offer high shares earnings so as to prove that they are profitable and worth investing in.

## Ratios

Ratios are indicators of a company’s health and may be manipulated to deceive users of financial statements such as creditors and investors. Alternatively, unusual values for certain ratios may be a sign that some underlying manipulation is taking place.

+----------------------------+--------------------+---------------------+
| Ratio Name                 |     Ratio Code     |       Formula       |
+:==========================:+:==================:+:===================:+
| Leverage Index             |   leverage_index   |     $$dltt/act$$    |
+----------------------------+--------------------+---------------------+
| Depreciation Index         |    depre_index     |  $$dp/(dp+ppent)$$  |
+----------------------------+--------------------+---------------------+
| Staff Administration Index |   saleadmin_index  |     $$xlr/revt$$    |
+----------------------------+--------------------+---------------------+

Liquidity ratios measure the ability of a company to meet its short-term financial obligations, while leverage ratios deal more with long-term obligations and provide a measure of the degree of risk taken on by the company. The lower the liquidity/leverage ratios, the higher the pressure on the company to misstate financial statements so as to avoid going into default or be faced with stricter covenants or penalties.  

These ratios analyse the efficiency of a company. They can reveal how fast the company is able to turn assets into cash. If a company is not using its resources well (e.g. not fully utilising its available assets to generate sales), it may manipulate its financial misstatements to look more favourable or appear to be profitable. Such ratios may also provide evidence that the accounts involved have been manipulated.

# Exploratory Data Analysis

Before we proceed to the model training, we have to see the general distribution of our y-variable (Restate_Int) with respect to certain key criteria such as Company Code, certain time series, as well as X-Values.

## Missing Data Points

This section will look at the ways we deal with missing data in the dataset. We will look at both missing data in the label (Y-Variable) as well as X-Variables.

### Missing Y-Variables (Restate_Int)

```{r include=FALSE}
library(dplyr)
df = read.csv("Restate_int_train.csv", stringsAsFactors = F)
#check the structure
str(df)
#change gvkey, year, restate to a factor
df$gvkey = as.factor(df$gvkey)
df$year = as.factor(df$year)
df$Restate_Int = as.factor(df$Restate_Int)
percent_intent = summary((df$Restate_Int))[2] / (summary((df$Restate_Int))[1] + 
summary((df$Restate_Int))[2]) * 100 
```

```{r echo=FALSE}
summary(df)
```

Generally, looking at the summary of the data, we can conclude that there is a low occurence of intentional accounting errors. There are in total **`r percent_intent`%** of datapoints that classifies as an intentional error (Restate_Int = 1).  

```{r, include=F}
library(ggplot2)
library(scales)
library(gridExtra)
```

```{r, fig.height = 10, fig.width = 12, echo=F}
#creation of important variables
#month
df = mutate(df, month = ifelse(substr(df$Date,2,2) == "/", substr(df$Date,1,1), substr(df$Date,1,2)))
df$month = as.integer(df$month)
df$month = as.factor(df$month)
#quarter
df = mutate(df, quarter = 
        ifelse(month == 1 | month == 2 | month == 3, 1,
        ifelse(month == 4 | month == 5 | month == 6, 2,
        ifelse(month == 7 | month == 8 | month == 9, 3, 4))))
df$quarter = as.integer(df$quarter)
df$quarter = as.factor(df$quarter)
#by company
df2 = head(df, 250)
ggplot(data = df2, aes(x = df2$gvkey)) +
labs(title = "Distribution of Intentional Error by Company",
     x = "Company Code", 
     y = "Frequency") + 
geom_bar(aes(fill = df2$Restate_Int), width = 0.35) +
scale_fill_discrete(name = "Intentional Error?",
labels = c("Not Intentional","Intentional")) + 
theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 20)) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

To better visualize the distribution, taking only top 250 data points, based on the plot above, there are lots of companies with no intentional error (red bars) at all. Using the full dataset, only **`r 100 - (313/4237*100)`%** of the data consist of misstatements, further proving that this occurrence is very rare. 

In addition to that, there is also a lot of companies with incomplete data (out of the 5 years, only have 1 year). This could be due to bankruptcy/delisting, recent IPO or just missing during data collection. 

To combat the latter, given that we are going to merge this dataset with the variables from CRSP/COMPUSTAT-MERGED datafile, we are going to do an outer join to take in those missing Restate_Int values. 

Moreover, given its rare occurrence, we are going to assume a default value of 0 (no misstatement) for these missing labels (y-values). Although this will result in an underestimation of the true positive (labelling actual misstatement as non-misstatement), we have more training dataset volume **<AMEND THIS(from r nrow to r nrow)>**, which facilitates better model learning.  

### Missing X-Values

Aside from missing Restate_Int values, there are also possible missing values in our selected X-Values. This could be because the figure is not a mandatory reporting requirement or the figure is not applicable in the context of the company. 

We started by identifying variables with >= 15% missing values

**<identify missing values in X>**

## Distribution of Misstatements
```{r, fig.height = 10, fig.width=12, echo = F,}
#identify companies with intentional error
df1 = read.csv("Restate_int_train.csv", stringsAsFactors = F)
df1 = df1 %>%
  group_by(gvkey) %>%
  mutate(Total = sum(Restate_Int)) %>%
  subset(Total != 0) %>%
  ungroup()
df1$gvkey = as.factor(df1$gvkey)
df1$Restate_Int = as.factor(df1$Restate_Int)
#month
df1 = mutate(df1, month = ifelse(substr(df1$Date,2,2) == "/", substr(df1$Date,1,1), substr(df1$Date,1,2)))
df1$month = as.integer(df1$month)
df1$month = as.factor(df1$month)
#quarter
df1 = mutate(df1, quarter = 
        ifelse(month == 1 | month == 2 | month == 3, 1,
        ifelse(month == 4 | month == 5 | month == 6, 2,
        ifelse(month == 7 | month == 8 | month == 9, 3, 4))))
df1$quarter = as.integer(df1$quarter)
df1$quarter = as.factor(df1$quarter)
df1 = head(df1, 250)
p1 = ggplot(data = df1, aes(x = df1$gvkey)) +
labs(title = "Distribution of Intentional Error by Company (at least 1 error)",
     x = "Company Code", 
     y = "Frequency") + 
geom_bar(aes(fill = Restate_Int), width = 0.35) +
scale_fill_discrete(name = "Intentional Error?",
labels = c("Not Intentional","Intentional")) + 
theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 20)) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
p1
```
To better visualize the distribution of misstatements, we took away all firms with 0 misstatements, and took the first 250 data points. Based on the above plot, we can see that among those with misstatements, Most of them only have 1 misstatement. It further proves that the occurrence is rare, although there are extremes values with 5 misstatements in 5 years. But we can still say that generally, the occurence is fairly rare.

```{r, fig.height=20, fig.width=12, echo = F}
#by year
p2=ggplot(data = df1, aes(x = df1$year)) +
scale_y_continuous(labels = percent) +
labs(title = "Distribution of Intentional Error by Year",
     x = "Year", 
     y = "Frequency") + 
geom_bar(aes(fill = df1$Restate_Int), width = 0.35, position = "fill") +
scale_fill_discrete(name = "Intentional Error?",
labels = c("Not Intentional","Intentional")) + 
theme(plot.title = element_text(hjust = 0.5))
#see by month
p3 = ggplot(data = df1, aes(x = df1$month)) +
scale_y_continuous(labels = percent) +
labs(title = "Distribution of Intentional Error by Month",
     x = "Month", 
     y = "Frequency") + 
geom_bar(aes(fill = df1$Restate_Int), width = 0.35, position = "fill") +
scale_fill_discrete(name = "Intentional Error?",
labels = c("Not Intentional","Intentional")) + 
theme(plot.title = element_text(hjust = 0.5))
#see by quarter
p4 = ggplot(data = df1, aes(x = df1$quarter)) +
scale_y_continuous(labels = percent) +
labs(title = "Distribution of Intentional Error by Quarter",
     x = "Quarter", 
     y = "Frequency") + 
geom_bar(aes(fill = df1$Restate_Int), width = 0.35, position = "fill") +
scale_fill_discrete(name = "Intentional Error?",
labels = c("Not Intentional","Intentional")) + 
theme(plot.title = element_text(hjust = 0.5))
grid.arrange(p2,p3,p4,nrow = 3)
```
Looking at the same dataset after filtering out those with no misstatements, we also look at the distribution of misstatements on different timeframes (Year, Month and Quarter). 

When plotted against year, there isn't any clear trend over the 5 years. Against month, there also isn't any clear trend, we can only say there is generally a spike on quarter start and end. And lastly, against quarter, there's no trend but we can see that most misstatements happen in quarter 2. 

# Modeling Methods and Algorithms

## lightbgm

## Logistic Regression
```{r, fig.height=20, fig.width=12, echo = F}
fit <- glm(Restate_int ~ ., data = df.train, family = binomial)
logodds <- predict(fit, df.test, type = "response")

test1 <- cbind(df.test, logodds)
test1 = test1[,c(1,16)]
colnames(test1)[2] = "Restate_Int"
write.csv(test1, "logistcs.csv", row.names = F)
```
Using a logistic regression model, data of the 15 identified features mentioned above was fed into the model, with a resulting out-of-sample AUC of 0.62484.

This model result was further processed (post-processing) to improve the results of out-of-sample.

```{r, fig.height=20, fig.width=12, echo = F}
Restate_List = unique(subset(df.train, df.train$Restate_int == 1)[,1])
post_processing = function(x){
  ifelse(x %in% Restate_List,0.6,0)}

test1['boosting'] = lapply(test1['gvkey'],post_processing)
test1['Restate_Int'] = test1['Restate_Int'] + test1['boosting']
test1$Restate_Int = ifelse(test1$Restate_Int > 1,1,test1$Restate_Int)
test1 = test1[,c(1,2)]
write.csv(test1, "log-post.csv", row.names=FALSE)
```

Hi

# Results

# References
http://www.theforensicauditor.com/2017/10/02/financial-statement-fraud/  
https://books.google.com.sg/books?id=S6Y2DwAAQBAJ&printsec=frontcover#v=onepage&q&f=false

